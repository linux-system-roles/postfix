---
- name: Create a postmapped file
  hosts: all

  vars:
    postfix_files:
      - name: test
        content: test_key test_value
        postmap: true

  tasks:
    - name: Run the role with test postmap file
      include_role:
        name: linux-system-roles.postfix
        public: true

    - name: Set postmap result file name
      set_fact:
        __postmap_file: /etc/postfix/test.{{
          postfix_map_type if postfix_map_type | length > 0
          else 'db' }}

    - name: Check if postmap file exists
      stat:
        path: "{{ __postmap_file }}"
      register: test_file
      changed_when: false

    - name: Assert file is present
      assert:
        that: test_file.stat.exists

    - name: Clean up test files
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /etc/postfix/test
        - "{{ __postmap_file }}"
